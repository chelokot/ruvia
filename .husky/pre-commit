#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# 1) Bump patch version (x.y.z -> x.y.z+1) in app.json, package.json, and Gradle
echo "[husky] Bumping patch version (SemVer patch)"
node scripts/bump-patch-version.js || exit 1

# 2) Format staged files with Prettier (non-destructive)
echo "[husky] Formatting staged files"
node scripts/format-staged.js || exit 1

# 3) Bump Android version code in app.json (and local Gradle) and show result
echo "[husky] Bumping Android versionCode"
node scripts/bump-version-code.js || exit 1
cat app.json | sed -n '1,80p' | rg -n 'versionCode' || true

# 4) Verify lockfiles are in sync (frontend + backend)
echo "[husky] Verifying npm lockfile (root)"
npm ci --silent --ignore-scripts --dry-run || {
  echo "[husky] npm ci lockfile check failed in root";
  exit 1;
}
if [ -f backend/package.json ]; then
  echo "[husky] Verifying npm lockfile (backend)"
  (cd backend && npm ci --silent --ignore-scripts --dry-run) || {
    echo "[husky] npm ci lockfile check failed in backend";
    exit 1;
  }
fi

# 5) Run frontend tests (root)
npm test -- --ci || exit 1

# 6) Run backend tests
if [ -d backend ]; then
  if [ -x backend/node_modules/.bin/jest ]; then
    (cd backend && npm test -- --ci) || exit 1
  else
    echo "[husky] Skipping backend tests (install dev deps to enable)"
  fi
fi
